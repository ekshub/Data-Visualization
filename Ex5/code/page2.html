<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Keyword Word Cloud</title>
    <style>
        body {
            font-family: 'Noto Sans', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
        }
        h1 {
            color: #333;
            margin-top: 20px;
        }
        #selectors {
            display: flex;
            gap: 20px;
            margin: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        #selectors label {
            font-size: 16px;
            color: #555;
        }
        #selectors select {
            padding: 5px 10px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        #container {
            display: flex;
            flex-direction: row;
            width: 90%;
            max-width: 1400px;
            margin: 20px 0;
        }
        #word-cloud {
            width: 60%;
            height: 600px;
            border: 1px solid #ddd;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #word-cloud svg {
            width: 100%;
            height: 100%;
        }
        #word-cloud p {
            position: absolute;
            color: #ff0000;
            font-size: 18px;
            text-align: center;
            padding: 20px;
        }
        #details {
            width: 35%;
            margin-left: 25px;
            background-color: #fff;
            border: 1px solid #ddd;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 20px;
            box-sizing: border-box;
            height: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #details h2 {
            margin-top: 0;
            color: #555;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            width: 100%;
            text-align: center;
        }
        .chart-container {
            width: 100%;
            height: 45%;
            margin-top: 20px;
            position: relative; /* 确保中心文本正确定位 */
        }
        /* 响应式设计 */
        @media (max-width: 1200px) {
            #container {
                flex-direction: column;
                align-items: center;
            }
            #word-cloud, #details {
                width: 100%;
                margin: 10px 0;
            }
            .chart-container {
                height: 40%;
            }
        }
    </style>
    <!-- 引入 Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Noto+Sans&display=swap" rel="stylesheet">
</head>
<body>
    <h1>Keyword Word Cloud</h1>
    <div id="selectors">
        <!-- 年份选择器 -->
        <div id="year-selector">
            <label for="year">Select Year: </label>
            <select id="year">
                <!-- Options will be dynamically generated by JavaScript -->
            </select>
        </div>
        <!-- 类别选择器 -->
        <div id="category-selector">
            <label for="category">Select Category: </label>
            <select id="category">
                <!-- Options will be dynamically generated by JavaScript -->
            </select>
        </div>
    </div>
    <div id="container">
        <div id="word-cloud">
            <!-- 词云将被绘制在这里 -->
        </div>
        <div id="details">
            <h2>Keyword Details</h2>
            <div class="chart-container">
                <canvas id="line-chart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="pie-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- 引入 D3.js 和 d3-cloud 库 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.min.js"></script>
    <!-- 引入 Chart.js 库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // 扩展停用词列表
        const stopwords = new Set([
            // 英语常见停用词
            "a", "an", "the", "and", "or", "but", "if", "while", "with",
            "to", "from", "of", "in", "on", "for", "by", "is", "are", "was",
            "were", "be", "been", "being", "have", "has", "had", "do", "does",
            "did", "will", "would", "shall", "should", "can", "could", "may",
            "might", "must", "this", "that", "these", "those", "it", "its",
            "as", "at", "about", "into", "over", "after", "before", "between",
            "under", "above", "below", "up", "down", "out", "off", "again",
            "further", "then", "once", "here", "there", "when", "where",
            "why", "how", "all", "any", "both", "each", "few", "more",
            "most", "other", "some", "such", "no", "nor", "not", "only",
            "own", "same", "so", "than", "too", "very","without","list","abo","problem",'paper','set','task','work','new','next','term'
        ]);

        // 定义类别选项
        const CS_SUBCATEGORIES = [ 
            "cs.AI", "cs.LG", "cs.CC", "cs.LO", "cs.MA",
            "cs.CL", "cs.IR", "cs.PL", "cs.CG", "cs.GR",
            "cs.RO", "cs.DB", "cs.IT", "cs.NE", "cs.DS",
            "cs.DL", "cs.SE", "cs.CE", "cs.MS", "cs.SC",
            "cs.DC", "cs.CV"
        ];

        // 定义年份范围
        const startYear = 1990;
        const endYear = 2024;

        // 获取选择器和容器元素
        const yearSelector = d3.select("#year");
        const categorySelector = d3.select("#category");
        const wordCloudContainer = d3.select("#word-cloud");
        const lineChartCtx = document.getElementById('line-chart').getContext('2d');
        const pieChartCtx = document.getElementById('pie-chart').getContext('2d');
        let lineChart; // 存储 Chart.js 实例

        // 定义词云颜色比例
        const color = d3.scaleOrdinal(d3.schemeCategory10);

        // 动态生成年份选项
        for (let year = startYear; year <= endYear; year++) {
            yearSelector.append("option")
                .attr("value", year)
                .text(year);
        }

        // 动态生成类别选项
        CS_SUBCATEGORIES.forEach(category => {
            categorySelector.append("option")
                .attr("value", category)
                .text(category);
        });

        // 设置初始年份和类别
        let selectedYear = 2010;
        let selectedCategory = CS_SUBCATEGORIES[0]; // 默认选择第一个类别
        yearSelector.property("value", selectedYear);
        categorySelector.property("value", selectedCategory);

        // 初始化数据结构
        const allData = {}; // { category: { year: { word: frequency, ... }, ... }, ... }
        const wordHistory = {}; // { category: { word: { year: frequency, ... }, ... }, ... }

        // 函数：加载特定类别的所有年份数据
        async function loadCategoryData(category) {
            if (allData[category]) {
                // 数据已加载，直接返回
                return;
            }
            allData[category] = {};
            wordHistory[category] = {};
            const promises = [];
            for (let year = startYear; year <= endYear; year++) {
                const dataPath = `keywords/${year}_${category}.json`;
                promises.push(d3.json(dataPath).then(data => {
                    allData[category][year] = data;
                    // 填充 wordHistory
                    for (const [word, freq] of Object.entries(data)) {
                        const cleanedWord = cleanWord(word);
                        if (!wordHistory[category][cleanedWord]) {
                            wordHistory[category][cleanedWord] = {};
                        }
                        wordHistory[category][cleanedWord][year] = freq;
                    }
                }).catch(error => {
                    console.error(`无法加载文件 ${dataPath}:`, error);
                    // 标记该年份的数据缺失
                    allData[category][year] = null;
                }));
            }
            await Promise.all(promises);
            console.log(`类别 ${category} 的所有年份数据已加载。`);
        }

        // 函数：清洗词汇
        function cleanWord(word) {
            word = word.toLowerCase();
            word = word.replace(/[^a-z\s]/g, ''); // 移除非字母字符
            word = word.trim();
            return word;
        }

        // 函数：检查是否为停用词
        function isStopword(word) {
            return stopwords.has(word);
        }

        // 初始化 SVG 和 g 元素
        function initializeSVG() {
            const svgWidth = wordCloudContainer.node().clientWidth;
            const svgHeight = wordCloudContainer.node().clientHeight;
            const svg = wordCloudContainer.append("svg")
                .attr("width", svgWidth)
                .attr("height", svgHeight);

            const g = svg.append("g")
                .attr("transform", `translate(${svgWidth / 2},${svgHeight / 2})`);

            return { svg, g, width: svgWidth, height: svgHeight };
        }

        let svgElements = initializeSVG();

        // 函数：动态确定显示的关键词数量
        function getMaxWords(width, height) {
            const area = width * height;
            // 设定每10000平方像素显示100个词，最多显示500个词
            return Math.min(500, Math.floor(area / 10000) * 10);
        }

        // 函数：绘制词云，保留过渡动画
        // 全局变量，用于存储单词位置
        let wordPositions = {};

        function drawWordCloud(words) {
            // 准备带有先前位置的单词数据
            const wordsWithPositions = words.map(d => {
                const word = { text: d.text, size: d.size };
                if (wordPositions[d.text]) {
                    word.x = wordPositions[d.text].x;
                    word.y = wordPositions[d.text].y;
                }
                return word;
            });

            // 设置词云布局
            const layout = d3.layout.cloud()
                .size([svgElements.width, svgElements.height])
                .words(wordsWithPositions)
                .padding(5) // 调整填充以避免重叠
                .rotate(() => 0)
                .font("Anton")
                .fontSize(d => {
                    const minSize = 12;
                    const maxSize = 60;
                    return Math.min(Math.max(d.size, minSize), maxSize);
                })
                .on("end", draw);

            layout.start();

            function draw(layoutWords) {
                // 更新wordPositions
                layoutWords.forEach(d => {
                    wordPositions[d.text] = { x: d.x, y: d.y };
                });

                // 数据绑定
                const texts = svgElements.g.selectAll("text")
                    .data(layoutWords, d => d.text);

                // 退出部分
                texts.exit()
                    .transition()
                    .duration(1000)
                    .style("opacity", 0)
                    .attr("transform", d => `translate(${d.x},${d.y})rotate(${d.rotate})`)
                    .style("font-size", "1px")
                    .remove();

                // 更新部分
                texts.transition()
                    .duration(1000)
                    .attr("transform", d => `translate(${d.x},${d.y})rotate(${d.rotate})`)
                    .style("font-size", d => `${d.size}px`)
                    .style("fill", d => color(d.text))
                    .style("opacity", 1);

                // 进入部分
                texts.enter().append("text")
                    .style("font-family", "Anton")
                    .style("fill", d => color(d.text))
                    .style("font-size", d => `${d.size}px`)
                    .attr("text-anchor", "middle")
                    .attr("transform", d => {
                        const previous = wordPositions[d.text];
                        const x = previous ? previous.x : d.x;
                        const y = previous ? previous.y : d.y;
                        return `translate(${x}, ${y})rotate(${d.rotate})`;
                    })
                    .style("opacity", 0)
                    .text(d => d.text)
                    .on("click", function(event, d) {
                        displayWordDetails(d.text);
                    })
                    .on("mouseover", function(event, d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .style("fill", "#ff6347")
                            .style("font-weight", "bold");
                    })
                    .on("mouseout", function(event, d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .style("fill", color(d.text))
                            .style("font-weight", "normal");
                    })
                    .transition()
                    .duration(1000)
                    .attr("transform", d => `translate(${d.x},${d.y})rotate(${d.rotate})`)
                    .style("opacity", 1);
            }
        }

        // 定义中心文本插件
        const centerTextPlugin = {
            id: 'centerText',
            afterDraw: (chart) => {
                if (chart.config.options.plugins.centerText) {
                    const { ctx, width, height } = chart;
                    ctx.save();
                    ctx.font = 'bold 20px Arial';
                    ctx.fillStyle = '#000';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(chart.config.options.plugins.centerText, width / 2, height / 2);
                    ctx.restore();
                }
            }
        };

        // 初始化饼图
        let pieChart = new Chart(pieChartCtx, {
            type: 'doughnut', // 使用环形图
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [],
                    borderColor: [],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '',
                        font: {
                            size: 18
                        }
                    },
                    legend: {
                        display: true,
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.chart._metasets[context.datasetIndex].total;
                                const percentage = ((value / total) * 100).toFixed(2);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    },
                    centerText: '' // 初始化为空
                },
                cutout: '50%', // 环形图的空心比例
                animation: {
                    animateRotate: true,
                    animateScale: true
                }
            },
            plugins: [centerTextPlugin] // 注册自定义插件
        });

        // 函数：显示关键词详细信息
        function displayWordDetails(word) {
            const frequencies = [];
            const years = [];
            let totalFrequency = 0;
            for (let year = startYear; year <= endYear; year++) {
                years.push(year);
                const freq = wordHistory[selectedCategory][word] && wordHistory[selectedCategory][word][year] ? wordHistory[selectedCategory][word][year] : 0;
                frequencies.push(freq);
                totalFrequency += freq;
            }

            // 绘制折线图
            if (lineChart) {
                lineChart.destroy();
            }

            lineChart = new Chart(lineChartCtx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: word,
                        data: frequencies,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: word,
                            font: {
                                size: 18
                            }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Frequency'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });

            // 获取当前年份的数据
            const currentYearData = allData[selectedCategory][selectedYear];
            if (currentYearData && currentYearData[word]) {
                const wordFreq = currentYearData[word];
                const totalFreq = Object.values(currentYearData).reduce((a, b) => a + b, 0);
                const otherFreq = totalFreq - wordFreq;

                // 计算百分比
                const percentage = ((wordFreq / totalFreq) * 100).toFixed(2) + '%';

                // 更新饼图数据
                pieChart.data.labels = [word, "Others"];
                pieChart.data.datasets[0].data = [wordFreq, otherFreq];
                pieChart.data.datasets[0].backgroundColor = [
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(201, 203, 207, 0.7)'
                ];
                pieChart.data.datasets[0].borderColor = [
                    'rgba(54, 162, 235, 1)',
                    'rgba(201, 203, 207, 1)'
                ];
                pieChart.options.plugins.title.text = word;
                pieChart.options.plugins.centerText = percentage;
                pieChart.update();
            } else {
                // 如果当前年份没有该词的数据，显示空饼图或提示信息
                pieChart.data.labels = ["No Data"];
                pieChart.data.datasets[0].data = [1];
                pieChart.data.datasets[0].backgroundColor = [
                    'rgba(201, 203, 207, 0.7)'
                ];
                pieChart.data.datasets[0].borderColor = [
                    'rgba(201, 203, 207, 1)'
                ];
                pieChart.options.plugins.title.text = word;
                pieChart.options.plugins.centerText = "0%";
                pieChart.update();
            }
        }

        // 函数：加载并绘制特定年份和类别的词云
        function loadAndDrawWordCloud(year, category) {
            const data = allData[category][year];
            // 检查数据是否存在且不为空
            if (!data || Object.keys(data).length === 0) {
                // 如果数据缺失或为空，清空词云并显示提示
                svgElements.g.selectAll("text")
                    .transition()
                    .duration(1000)
                    .style("opacity", 0)
                    .remove();
                wordCloudContainer.selectAll("p").remove();
                wordCloudContainer.append("p")
                    .style("color", "#ff0000")
                    .style("font-size", "18px")
                    .style("text-align", "center")
                    .style("margin-top", "20px")
                    .text(!data ? `类别 ${category} 在 ${year} 年没有有效的关键词数据。`: `类别 ${category} 在 ${year} 年没有相关数据。`)
                    .style("opacity", 0)
                    .transition()
                    .duration(1000)
                    .style("opacity", 1);
                return;
            } else {
                wordCloudContainer.selectAll("p").remove();
            }

            // 转换数据为数组格式并按频率降序排序
            let words = Object.keys(data)
                .map(word => ({ text: cleanWord(word), size: data[word] }))
                .filter(d => d.text.length > 2 && !isStopword(d.text))
                .sort((a, b) => b.size - a.size);

            // 检查过滤后的词汇是否为空
            if (words.length === 0) {
                // 如果没有有效的词汇，清空词云并显示提示
                svgElements.g.selectAll("text")
                    .transition()
                    .duration(1000)
                    .style("opacity", 0)
                    .remove();
                wordCloudContainer.selectAll("p").remove();
                wordCloudContainer.append("p")
                    .style("color", "#ff0000")
                    .style("font-size", "18px")
                    .style("text-align", "center")
                    .style("margin-top", "20px")
                    .text(`类别 ${category} 在 ${year} 年没有有效的关键词数据。`)
                    .style("opacity", 0)
                    .transition()
                    .duration(1000)
                    .style("opacity", 1);
                return;
            }

            // 动态确定要显示的关键词数量
            const maxWords = getMaxWords(svgElements.width, svgElements.height);
            words = words.slice(0, maxWords);

            drawWordCloud(words);
        }

        // 监听年份选择变化
        yearSelector.on("change", function() {
            selectedYear = this.value;
            loadAndDrawWordCloud(selectedYear, selectedCategory);
        });

        // 监听类别选择变化
        categorySelector.on("change", function() {
            selectedCategory = this.value;
            loadCategoryData(selectedCategory).then(() => {
                loadAndDrawWordCloud(selectedYear, selectedCategory);
            });
        });

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // 监听窗口大小变化，重新绘制词云以适应新尺寸
        window.addEventListener('resize', debounce(() => {
            // 更新 SVG 尺寸
            const newWidth = wordCloudContainer.node().clientWidth;
            const newHeight = wordCloudContainer.node().clientHeight;
            svgElements.svg
                .attr("width", newWidth)
                .attr("height", newHeight);
            svgElements.g
                .attr("transform", `translate(${newWidth / 2},${newHeight / 2})`);
            
            // 重新初始化布局尺寸
            svgElements.width = newWidth;
            svgElements.height = newHeight;

            // 动态调整 maxWords
            const maxWords = getMaxWords(newWidth, newHeight);

            // 重新加载当前年份和类别的词云
            loadAndDrawWordCloud(selectedYear, selectedCategory);
        }, 300)); // 等待 300 毫秒后执行

        // 初始加载类别数据并绘制词云
        loadCategoryData(selectedCategory).then(() => {
            loadAndDrawWordCloud(selectedYear, selectedCategory);
        });
    </script>
</body>
</html>
