<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>论文信息查询与词云展示</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
    }
    #wordCloud {
        width: 800px;
        height: 600px;
        margin-top: 20px;
        border: 1px solid #ccc;
    }
    /* 禁止所有文字被选中 */
    body {
        -webkit-user-select: none; /* Safari */
        -moz-user-select: none;    /* Firefox */
        -ms-user-select: none;     /* IE10+/Edge */
        user-select: none;         /* 标准语法 */
    }
</style>
</head>
<body>
<h1>论文信息查询与词云展示（测试中）</h1>
<label for="paperId">输入 arXiv 论文编号：</label>
<input type="text" id="paperId" value="2103.05127v2">
<button id="searchBtn">查询</button>

<h2>论文信息</h2>
<div id="paperInfo">
    <!-- 论文信息将在这里显示 -->
</div>

<h2>论文摘要</h2>
<div id="abstract">
    <!-- 摘要将在这里显示 -->
</div>

<h2>发表日期</h2>
<div id="publishedDate">
    <!-- 发表日期将在这里显示 -->
</div>

<h2>论文摘要词云</h2>
<div id="wordCloud">
    <!-- 词云将在这里绘制 -->
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- 引入 d3-cloud 插件 -->
<script src="https://cdn.jsdelivr.net/npm/d3-cloud@1.2.5/build/d3.layout.cloud.js"></script>

<script>
document.getElementById('searchBtn').addEventListener('click', function() {
    const paperId = document.getElementById('paperId').value.trim();
    if (paperId === '') {
        alert('请输入论文编号');
        return;
    }

    fetch(`/getPaperInfo?paperId=${encodeURIComponent(paperId)}`)
    .then(response => {
        if (!response.ok) {
            // 如果响应状态不是 200，抛出错误
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        // 显示论文信息
        displayPaperInfo(data);
        // 显示论文摘要
        displayAbstract(data.abstract);
        // 显示发表日期
        displayPublishedDate(data.published);
        // 绘制词云
        drawWordCloud(data.wordCloudData);
    })
    .catch(error => {
        console.error('Error:', error);
        alert(`请求失败：${error.message}`);
    });
});

function displayPaperInfo(data) {
    const paperInfoDiv = document.getElementById('paperInfo');
    paperInfoDiv.innerHTML = `
        <p><strong>标题：</strong>${data.title}</p>
        <p><strong>作者：</strong>${data.authors.join(', ')}</p>
        <p><strong>学科领域：</strong>${data.categories.join(', ')}</p>
        <p><strong>论文字数：</strong><span id="wordCount">${data.wordCount}</span></p>
    `;
}

function displayAbstract(abstract) {
    const abstractDiv = document.getElementById('abstract');
    abstractDiv.innerHTML = `
        <p>${abstract}</p>
    `;
}

function displayPublishedDate(published) {
    const publishedDateDiv = document.getElementById('publishedDate');
    const date = new Date(published);
    const formattedDate = date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    publishedDateDiv.innerHTML = `
        <p>${formattedDate}</p>
    `;
}

function drawWordCloud(words) {
    // 清空之前的词云内容
    d3.select("#wordCloud").html("");

    const width = 800;
    const height = 600;

    const layout = d3.layout.cloud()
        .size([width, height])
        .words(words.map(d => ({text: d.text, size: d.size})))
        .padding(5)
        .rotate(() => (Math.random() > 0.5 ? 90 : 0))
        .font("Impact")
        .fontSize(d => d.size)
        .on("end", draw);

    layout.start();

    function draw(words) {
        const svg = d3.select("#wordCloud")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const group = svg.append("g")
            .attr("transform", `translate(${width / 2}, ${height / 2})`);
        
        group.selectAll("text")
            .data(words)
            .enter()
            .append("text")
            .style("font-family", "Impact")
            .style("font-size", d => d.size + "px")
            .style("fill", () => d3.interpolateRainbow(Math.random()))
            .attr("text-anchor", "middle")
            .attr("transform", d => `translate(${d.x}, ${d.y}) rotate(${d.rotate})`)
            .text(d => d.text);
    }
}
</script>
</body>
</html>